



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Concurrencia en iOS - TPDAM-iOS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#concurrencia-en-ios" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="TPDAM-iOS" class="md-header-nav__button md-logo">
          
            <img src="../../logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              TPDAM-iOS
            </span>
            <span class="md-header-nav__topic">
              
                Concurrencia en iOS
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="TPDAM-iOS" class="md-nav__button md-logo">
      
        <img src="../../logo.png" width="48" height="48">
      
    </a>
    TPDAM-iOS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../s1/swift_basico/" title="Introducción básica a Swift" class="md-nav__link">
      Introducción básica a Swift
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../s1/ejercicios/" title="Ejercicios de Swift básico" class="md-nav__link">
      Ejercicios de Swift básico
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../s2/aplicaciones_ios/" title="Introducción a las aplicaciones iOS" class="md-nav__link">
      Introducción a las aplicaciones iOS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../s2/recursos/" title="Recursos en aplicaciones iOS" class="md-nav__link">
      Recursos en aplicaciones iOS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../s2/ejercicios/" title="Ejercicios sobre aplicaciones iOS" class="md-nav__link">
      Ejercicios sobre aplicaciones iOS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../intro_swift_2/" title="Más sobre Swift" class="md-nav__link">
      Más sobre Swift
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Concurrencia en iOS
      </label>
    
    <a href="./" title="Concurrencia en iOS" class="md-nav__link md-nav__link--active">
      Concurrencia en iOS
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#concurrencia-en-ios" class="md-nav__link">
    Concurrencia en iOS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apis-de-concurrencia" class="md-nav__link">
    APIs de concurrencia
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#colas-de-operaciones" class="md-nav__link">
    Colas de operaciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-cola-de-operaciones-principal-de-una-app" class="md-nav__link">
    La cola de operaciones principal de una app
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../s4/comunicacion/" title="Comunicación entre componentes" class="md-nav__link">
      Comunicación entre componentes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../s4/i18n/" title="Internacionalización de aplicaciones iOS" class="md-nav__link">
      Internacionalización de aplicaciones iOS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../s4/ejercicio_i18n/" title="Ejercicio de i18n" class="md-nav__link">
      Ejercicio de i18n
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../miniproyecto/proyecto/" title="Miniproyecto. Juego de las siete y media" class="md-nav__link">
      Miniproyecto. Juego de las siete y media
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../apendices/control_versiones/" title="Apéndice 1. Control de versiones en Xcode" class="md-nav__link">
      Apéndice 1. Control de versiones en Xcode
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../s5/testing/" title="Apéndice 2. Testing en Xcode" class="md-nav__link">
      Apéndice 2. Testing en Xcode
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#concurrencia-en-ios" class="md-nav__link">
    Concurrencia en iOS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apis-de-concurrencia" class="md-nav__link">
    APIs de concurrencia
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#colas-de-operaciones" class="md-nav__link">
    Colas de operaciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-cola-de-operaciones-principal-de-una-app" class="md-nav__link">
    La cola de operaciones principal de una app
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Concurrencia en iOS</h1>
                
                <h2 id="concurrencia-en-ios">Concurrencia en iOS<a class="headerlink" href="#concurrencia-en-ios" title="Permanent link">&para;</a></h2>
<p>En muchas aplicaciones iOS necesitaremos efectuar varias operaciones de modo concurrente. El caso más típico es cuando queremos hacer una operación costosa en tiempo pero no queremos que se paralice la interfaz de usuario hasta que termine la operación.</p>
<h3 id="apis-de-concurrencia">APIs de concurrencia<a class="headerlink" href="#apis-de-concurrencia" title="Permanent link">&para;</a></h3>
<p>Tanto iOS como OSX tienen varios APIs con distinto nivel de abstracción para trabajar con operaciones concurrentes:</p>
<ul>
<li>En el nivel más bajo estaría trabajar directamente con <em>threads</em>, representados por la clase del sistema <code>NSThread</code>. La mayoría de aplicaciones no necesitan la flexibilidad que nos proporciona trabajar a este nivel, o no merece la pena teniendo en cuenta lo complicado del código con respecto a las otras alternativas.</li>
<li>En un nivel intermedio tenemos un <em>framework</em> de Apple llamado <em>grand central dispatch</em> o GCD. Tiene un nivel de abstracción razonable para la mayoría de aplicaciones, de hecho en Internet podéis encontrar multitud de tutoriales y ejemplos que lo usan (podéis verlo por la llamada a una función llamada <code>dispatch_async</code>, que pone en marcha código concurrente).</li>
<li>En el nivel más alto de abstracción están las <em>colas de operaciones</em> (aunque no es mucho mayor que GCD). Es el API que vamos a usar aquí ya que es el más sencillo de usar.</li>
</ul>
<p>Cada API usa internamente los otros de más bajo nivel. Es decir, GCD usa internamente <em>threads</em> y las colas de operaciones usan internamente GCD.</p>
<h3 id="colas-de-operaciones">Colas de operaciones<a class="headerlink" href="#colas-de-operaciones" title="Permanent link">&para;</a></h3>
<p>En una <em>cola de operaciones</em> podemos añadir trabajos concurrentes. Manejarlas a nivel básico es muy sencillo. Son instancias de <code>OperationQueue</code> y para añadir un trabajo a una solo hay que llamar a <code>addOperation()</code>. Hay diversas formas de pasar el código a ejecutar. La más cómoda es en forma de <em>clausura</em>. Por ejemplo:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">cola</span> <span class="p">=</span> <span class="n">OperationQueue</span><span class="p">();</span>
<span class="n">cola</span><span class="p">.</span><span class="n">addOperation</span><span class="p">()</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;comienza operación 1...&quot;</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;...hecho 1&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">cola</span><span class="p">.</span><span class="n">addOperation</span><span class="p">()</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;comienza operacion 2...&quot;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;...hecho 2&quot;</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</td></tr></table>

<blockquote>
<p>NOTA: podemos ver el resultado del código anterior añadiéndolo por ejemplo a una aplicación iOS. Si usamos una aplicación de línea de comandos tendremos que añadir algo al código ya que si no el programa principal terminaría inmediatamente después del segundo <code>addOperation</code> y no se verían los mensajes en pantalla. Por ejemplo podemos llamar a <code>cola.waitUntilAllOperationsAreFinished()</code>  que como su propio nombre indica se espera hasta que todas las operaciones añadidas a la cola han terminado.</p>
</blockquote>
<p>Si ejecutamos el código anterior veremos que aunque el código de la primera clausura comienza a ejecutarse primero, aun así termina después, es decir, ambas "tareas" se están ejecutando en paralelo y no secuencialmente. Por defecto este es el comportamiento de las colas de operaciones, aunque podemos definir dependencias entre tareas, de modo que se ejecute una solo cuando ha acabado otra determinada. Incluso podemos limitar el número de operaciones concurrentes que se pueden ejecutar en una cola.</p>
<h3 id="la-cola-de-operaciones-principal-de-una-app">La cola de operaciones principal de una <em>app</em><a class="headerlink" href="#la-cola-de-operaciones-principal-de-una-app" title="Permanent link">&para;</a></h3>
<p>En aplicaciones iOS está predefinida lo que se llama la "cola de operaciones principal", que es la que ejecuta el código que actualiza la interfaz de usuario. Podemos acceder a ella con <code>OperationQueue.main</code>. Esta cola de operaciones no puede ejecutar operaciones concurrentes para evitar inconsistencias, que se podrían dar si dos tareas estuvieran modificando simultáneamente el mismo elemento de la interfaz. Podemos comprobar esto imprimiendo el valor de <code>OperationQueue.main.maxConcurrentOperationCount</code>, que veremos que vale 1, es decir, no hay operaciones concurrentes en esta cola.</p>
<p>Cuando necesitamos ejecutar una operación especialmente costosa en tiempo no es recomendable bloquear la interfaz de usuario, por lo que se suele crear una cola de operaciones aparte de la principal y ejecutar la operación en esta.  </p>
<p>Un problema adicional es que normalmente esta operación costosa debe actualizar la interfaz de usuario al finalizar, pero ningún hilo de ejecución que no sea el principal debe actualizar la interfaz de usuario, ya que lo contrario podría producir resultados inconsistentes. Esto lo podemos resolver accediendo a la cola de operaciones principal con <code>OperationQueue.main</code>. Por ejemplo:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">background</span> <span class="p">=</span> <span class="n">OperationQueue</span><span class="p">();</span>
<span class="n">background</span><span class="p">.</span><span class="n">addOperation</span><span class="p">()</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Comienzo mi duro trabajo...&quot;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;...terminado!&quot;</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;pero yo NO DEBO tocar la interfaz&quot;</span><span class="p">)</span>
    <span class="n">OperationQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">addOperation</span><span class="p">()</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Soy main. Desde aquí sí se puede actualizar la interfaz&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../intro_swift_2/" title="Más sobre Swift" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Anterior
                </span>
                Más sobre Swift
              </span>
            </div>
          </a>
        
        
          <a href="../../s4/comunicacion/" title="Comunicación entre componentes" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Siguiente
                </span>
                Comunicación entre componentes
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>